@model BusinessObjects.Models.Auditorium
@using System.Text.Json
@using BusinessObjects.Models;
@{
    ViewData["Title"] = "View";
    string rows = "ABCDEFGHIJKLMN";
    List<Seat> Seats = Model.Seats.ToList();
    int curIndex = 0;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Seat Booking</title>
</head>
<body>
    <div class="movie-booking">
        <!-- Progress Bar - Updated structure -->
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-line"></div>
                <div class="step completed">Chọn phim/Rạp/Suất</div>
                <div class="step active">Chọn ghế</div>
                <div class="step">Thanh toán</div>
                <div class="step">Xác nhận</div>
            </div>
        </div>
        <div class="main-content">
            <!-- Left Section -->
            <div class="left-section">
                <!-- Showtime Selection -->
                <div class="showtime-selection">
                    <h3>Đổi  suất chiếu</h3>
                    <div class="showtime-buttons">
                        <button class="time-btn active" data-time="17:00">17:00</button>
                        <button class="time-btn" data-time="22:00">22:00</button>
                    </div>
                </div>
                <!-- Seat Grid -->
                <div class="seat-grid-container">
                    @* <div class="seat-grid-header" id="seat-grid-header"> *@
                    <div class="seat-grid-header">
                        <!-- Column numbers will be generated by JavaScript -->
                        @for ( int i = 1; i <= @Model.ColumnNumber; i++ )
                        {
                            <div class="seat-col-number">@i</div>
                        }
                    </div>
                    <div class="seat-grid" id="seat-grid">
                        @for (int i = 0; i < rows.Length; i++)
                        {
                            <div class="seat-row">
                                <div class="seat-row-letter">@rows[i]</div>
                                @for (int j = 0; j < Model.ColumnNumber; j++, curIndex++)
                                {
                                    <div class="SeatType" data-type="@Seats[curIndex].SeatType" data-id="@Seats[curIndex].SeatId" data-seatsold="@Seats[curIndex].IsAvailable"
                                         onclick="handleSeatClick(@Seats[curIndex].SeatId)" data-seatnumber="@Seats[curIndex].SeatNumber" data-seatprice="@Seats[curIndex].SeatTypeNavigation.Price"></div>
                                }
                            </div>
                        }
                    </div>
                </div>
                <!-- Screen -->
                <div class="screen">
                    <div class="screen-label">MÀN HÌNH</div>
                </div>
                <!-- Legend -->
                <div class="seat-legend">
                    <div class="legend-item">
                        <div class="legend-box normal"></div>
                        <span>Ghế thường</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box vip"></div>
                        <span>Ghế VIP</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box couple"></div>
                        <span>Ghế couple</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box sold"></div>
                        <span>Ghế đã bán</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box selected"></div>
                        <span>Ghế đang chọn</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box unavailable"></div>
                        <span>Ghế không khả dụng</span>
                    </div>
                </div>
            </div>
            <!-- Right Section -->
            <div class="right-section">
                <div class="movie-details">
                    <div class="movie-poster">
                        <img src="https://placehold.co/140x200/red/white?text=Movie" alt="Movie Poster" />
                    </div>
                    <div class="movie-info">
                        <h2>Bộ Tứ Báo Thù</h2>
                        <div class="movie-tag">2D Phụ Đề</div>
                        <div class="theater-info">Chicken Đà Nẵng - Rạp 4</div>
                        <div class="showtime-info">
                            Suất chiếu: <strong id="current-time">17:00</strong>, Hôm nay
                        </div>
                    </div>
                </div>
                <div class="booking-details">
                    <div class="selected-seats" id="selected-seats-container">
                        <!-- Selected seats will be displayed by JavaScript -->
                    </div>
                    <div class="total-section">
                        <div class="total-label">Tổng cộng:</div>
                        <div class="total-price" id="total-price">0vnđ</div>
                    </div>
                    <div class="action-buttons">
                        <button class="back-btn">Quay lại</button>
                        <button class="payment-btn">Thanh toán</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Payment Success Modal -->
        <div id="payment-success-modal" class="modal">
            <div class="modal-content">
                <div class="success-icon">✓</div>
                <h2 class="modal-title">Thanh toán thành công!</h2>
                <p class="modal-message">
                    Cảm ơn bạn đã đặt vé xem phim. Vé của bạn đã được xác nhận.<br>
                    Mã đặt vé: <strong id="booking-code">ABC12345</strong><br>
                    Vui lòng kiểm tra email để nhận thông tin chi tiết.
                </p>
                <div class="modal-buttons">
                    <button class="modal-button secondary" id="view-tickets-btn">Xem vé của tôi</button>
                    <button class="modal-button primary" id="home-btn">Về trang chủ</button>
                </div>
            </div>
        </div>

        <div id="payment-confirm" class="popup-information-book-ticket">
            <div class="information-book-ticket">
                <h1 class="title-indformation-book-ticket-popup">THÔNG TIN ĐẶT VÉ</h1>
                <div class="h-50">
                    <div class="detail-book-ticket-popup">
                        <div class="text-detail-book-ticket-popup">Phim</div>
                        <div class="infor-detail-book-ticket-popup">
                            <h3 class="header-infor-detail-book-ticket-popup">Bộ tứ báo thủ</h3>
                            <p class="description-infor-detail-book-ticket-popup">2d phụ đề</p>
                        </div>
                    </div>
                    <div class="detail-book-ticket-popup">
                        <div class="text-detail-book-ticket-popup">Rạp</div>
                        <div class="infor-detail-book-ticket-popup">
                            <h3 class="header-infor-detail-book-ticket-popup">Chicken Đà Nẵng</h3>
                            <p class="description-infor-detail-book-ticket-popup">Suất: 17h30</p>
                        </div>
                    </div>
                    <div class="detail-book-ticket-popup">
                        <div class="text-detail-book-ticket-popup">Chi tiet</div>
                        <div class="infor-detail-book-ticket-popup">
                            <p id="description-infor-detail-book-ticket-popup" class="description-infor-detail-book-ticket-popup">Rạp 4, ghế G4, G5</p>
                        </div>
                    </div>
                </div>
                <div class="total-confirm-pay-ticket">
                    <div class="total-ticket">
                        <div class="text-detail-book-ticket-popup">Tổng</div>
                        <div id="price-detail-book-ticket" class="price-detail-book-ticket">220.000VND</div>
                    </div>
                    <hr />
                    <form asp-controller="Auditorium" method="post" asp-action="OnPay">
                        <button id="payment-btn-confirm" class="payment-btn-confirm">Thanh toán</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <script>
         const divs = document.querySelectorAll(".SeatType");
         let selectedIds = [];
          function handleSeatClick(seatId) {
             if ( !selectedIds.includes(seatId) ) {
                   selectedIds.push(seatId);
             } else {
                    selectedIds = selectedIds.filter(seat => seat !== seatId);
              }
              updateSeatGrid();
              updateSelectedSeatsDisplay();
               updateTotalPrice();
         }
         function getSeatNumberById(seat) {
             let seatNumbers = [];
            divs.forEach(div => {
               const seatId = Number(div.dataset.id);
               if ( seat.includes(seatId) ) {
                    const SeatNumber = div.dataset.seatnumber;
					 seatNumbers.push(SeatNumber);
               }
            });
			 return seatNumbers.join(', ');
         }
         function updateSeatGrid() {
            divs.forEach(div => {
              const seatTypeValue = div.dataset.type;
              const seatId = Number(div.dataset.id);
              const isAvailable = div.dataset.seatsold;
              function getSeatClass(seatType, isAvailable) {
                  if (isAvailable === "False") return "seat sold";
                  if (seatType === "Seat_VIP") return "seat vip";
                  if (seatType === "Seat_Deluxe") return "seat vip";
                  if (seatType === "Seat_Couple") return "seat couple";
                  return "seat normal";
              }
                console.log(selectedIds.includes(seatId));
              if ( selectedIds.includes(seatId) ) {
                  div.className = "seat selected";
              } else {
                  div.className = getSeatClass(seatTypeValue, isAvailable);
              }
            });
          }
          function updateSelectedSeatsDisplay() {
             const container = document.getElementById('selected-seats-container');
             container.innerHTML = '';
             if (selectedIds.length > 0) {
               const seatTypeElement = document.createElement('div');
               seatTypeElement.className = 'seat-type';
               container.appendChild(seatTypeElement);
               const seatIdElement = document.createElement('div');
               seatIdElement.className = 'seat-id';
                 seatIdElement.textContent = `Ghế - ${getSeatNumberById(selectedIds)}`;
               container.appendChild(seatIdElement);
             }
           }
          function updateTotalPrice() {
             const totalPrice = calculateTotal();
             document.getElementById('total-price').textContent = `${formatNumber(totalPrice)}vnđ`;
            }
          function calculateTotal() {
             if ( selectedIds.length <= 0 ) {
                  return 0;
             } else {
                  let total = 0;
                  const audiPrice = @Model.AuditoriumTypeNavigation.Price;
                  divs.forEach(div => {
                   const seatId = Number(div.dataset.id);
                   if ( selectedIds.includes(seatId) ) {
                     const seatPrice = Number(div.dataset.seatprice) + Number(audiPrice);
                     total += seatPrice;
                   }
                  });
                  return Number(total);
              }
            }
          function formatNumber(num) {
             return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
           }
       document.addEventListener("DOMContentLoaded", function () {
         updateSeatGrid();
        });
    </script>
</body>
</html>

